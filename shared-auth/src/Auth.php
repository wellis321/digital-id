<?php
/**
 * Authentication Class
 * Handles user authentication, sessions, and password management
 */

class Auth {
    
    /**
     * Check if user is logged in
     */
    public static function isLoggedIn() {
        // Ensure session is started
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
        
        // Check if user_id exists in session
        if (!isset($_SESSION['user_id']) || empty($_SESSION['user_id'])) {
            return false;
        }
        
        // Verify user still exists and is active in database
        $userId = $_SESSION['user_id'];
        
        // WORKAROUND: Store user_id, organisation_id, and CSRF token before database check to preserve them if query fails
        // This prevents session clearing on transient database query failures
        // This works even if old cached code clears the session - we can restore it
        $savedUserId = $userId;
        $savedOrganisationId = $_SESSION['organisation_id'] ?? null;
        $savedCsrfToken = $_SESSION[CSRF_TOKEN_NAME] ?? null;
        
        // Register shutdown function to restore session if it was cleared by old cached code
        // This is a workaround for PHP opcode cache serving old code that clears the session
        register_shutdown_function(function() use ($savedUserId, $savedOrganisationId, $savedCsrfToken) {
            // Don't restore if this is an intentional logout
            // Check if we're in logout.php or if logout flag was set
            $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
            $isLogout = strpos($scriptName, 'logout.php') !== false;
            
            // Check if logout flag was set (indicates intentional logout)
            $logoutIntentional = isset($_SESSION['_logout_intentional']) && $_SESSION['_logout_intentional'] === true;
            
            // Also check if session was intentionally destroyed
            $sessionDestroyed = session_status() === PHP_SESSION_NONE;
            
            // Only restore if this looks like a transient failure (not an intentional logout)
            if (!empty($savedUserId) && !$isLogout && !$logoutIntentional && !$sessionDestroyed && (empty($_SESSION['user_id']) || $_SESSION['user_id'] != $savedUserId)) {
                // Only restore if this looks like a transient failure (user_id was valid before)
                $_SESSION['user_id'] = $savedUserId;
                if ($savedOrganisationId !== null) {
                    $_SESSION['organisation_id'] = $savedOrganisationId;
                }
                if ($savedCsrfToken !== null) {
                    $_SESSION[CSRF_TOKEN_NAME] = $savedCsrfToken;
                }
                error_log('Restored session for user_id: ' . $savedUserId . ' (org_id: ' . ($savedOrganisationId ?? 'null') . ') after transient database query failure');
            }
        });
        
        $db = getDbConnection();
        
        if (!$db) {
            return false;
        }
        
        $user = false;
        $stmtError = null;
        try {
            $stmt = $db->prepare("SELECT id, is_active, email_verified FROM users WHERE id = ?");
            $stmt->execute([$userId]);
            $user = $stmt->fetch();
            $stmtError = $stmt->errorInfo();
            
            // If query returned false but there's no error, user truly doesn't exist
            // However, if there's a database error code, treat it as a transient failure
            if ($user === false && $stmtError && $stmtError[0] !== '00000') {
                // Database error occurred - don't clear session
                error_log('Database query error during user verification (user_id: ' . $userId . '): ' . ($stmtError[2] ?? 'Unknown error'));
                return true; // Assume user is still logged in
            }
        } catch (Exception $e) {
            // On database error, don't clear session - assume user is still valid
            // This prevents logout on transient database errors
            error_log('Database error during user verification: ' . $e->getMessage());
            return true; // Assume user is still logged in if we can't verify
        }
        
        // Only clear session if user is explicitly not found or inactive
        // Don't clear on database errors (handled above)
        if ($user === false) {
            // User not found in database - but this might be a transient query failure
            // Since we have a valid user_id in session, be conservative and don't clear session
            // This prevents logout on transient database query failures
            // WORKAROUND: Preserve session if we had a valid user_id before the query
            if (!empty($savedUserId) && $savedUserId == $userId) {
                // Restore user_id in session if it was cleared
                if (empty($_SESSION['user_id'])) {
                    $_SESSION['user_id'] = $savedUserId;
                }
                error_log('User verification query returned false for user_id: ' . $userId . ' - preserving session due to transient failure');
                return true; // Assume user is still logged in to prevent logout on transient failures
            }
            
            // User truly not found - clear session
            error_log('User verification query returned false for user_id: ' . $userId . ' - clearing session');
            $csrfToken = $_SESSION[CSRF_TOKEN_NAME] ?? null;
            $_SESSION = [];
            if ($csrfToken !== null) {
                $_SESSION[CSRF_TOKEN_NAME] = $csrfToken;
            }
            return false;
        }
        
        if (!$user['is_active']) {
            // User is inactive - clear session
            $csrfToken = $_SESSION[CSRF_TOKEN_NAME] ?? null;
            $_SESSION = [];
            if ($csrfToken !== null) {
                $_SESSION[CSRF_TOKEN_NAME] = $csrfToken;
            }
            return false;
        }
        
        return true;
    }
    
    /**
     * Get current user ID
     */
    public static function getUserId() {
        return $_SESSION['user_id'] ?? null;
    }
    
    /**
     * Get current user organisation ID
     */
    public static function getOrganisationId() {
        return $_SESSION['organisation_id'] ?? null;
    }
    
    /**
     * Get current user data
     */
    public static function getUser() {
        if (!self::isLoggedIn()) {
            return null;
        }
        
        if (!isset($_SESSION['user_data'])) {
            $db = getDbConnection();
            $stmt = $db->prepare("SELECT * FROM users WHERE id = ?");
            $stmt->execute([self::getUserId()]);
            $_SESSION['user_data'] = $stmt->fetch();
        }
        
        return $_SESSION['user_data'];
    }
    
    /**
     * Login user
     */
    public static function login($email, $password) {
        $db = getDbConnection();
        
        $stmt = $db->prepare("
            SELECT u.*, o.id as organisation_id, o.name as organisation_name 
            FROM users u 
            LEFT JOIN organisations o ON u.organisation_id = o.id
            WHERE u.email = ?
        ");
        $stmt->execute([$email]);
        $user = $stmt->fetch();
        
        if ($user && password_verify($password, $user['password_hash'])) {
            // Check if email is verified (only if email_verified column exists)
            // For superadmin users created before email verification migration, email_verified may not exist
            $emailVerified = $user['email_verified'] ?? true; // Default to true if column doesn't exist
            if (!$emailVerified) {
                return ['error' => 'email_not_verified', 'message' => 'Please verify your email address before logging in. Check your inbox for the verification link.'];
            }
            
            // Check if account is active
            if (!$user['is_active']) {
                return ['error' => 'account_inactive', 'message' => 'Your account has been deactivated. Please contact your administrator.'];
            }
            
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['organisation_id'] = $user['organisation_id'];
            $_SESSION['email'] = $user['email'];
            $_SESSION['user_data'] = $user;
            
            // Update last login
            $stmt = $db->prepare("UPDATE users SET last_login = NOW() WHERE id = ?");
            $stmt->execute([$user['id']]);
            
            return true;
        }
        
        return false;
    }
    
    /**
     * Verify email address with token
     */
    public static function verifyEmail($token) {
        $db = getDbConnection();
        
        $stmt = $db->prepare("
            SELECT id, email, first_name, verification_token_expires_at 
            FROM users 
            WHERE verification_token = ? AND email_verified = FALSE
        ");
        $stmt->execute([$token]);
        $user = $stmt->fetch();
        
        if (!$user) {
            return ['success' => false, 'message' => 'Invalid or expired verification token.'];
        }
        
        // Check if token has expired
        if (strtotime($user['verification_token_expires_at']) < time()) {
            return ['success' => false, 'message' => 'Verification token has expired. Please request a new verification email.'];
        }
        
        // Get organisation ID before updating
        $stmt = $db->prepare("SELECT organisation_id FROM users WHERE id = ?");
        $stmt->execute([$user['id']]);
        $userOrg = $stmt->fetch();
        
        if (!$userOrg) {
            return ['success' => false, 'message' => 'User organisation not found.'];
        }
        
        // Check if seats are available before verifying
        $stmt = $db->prepare("
            SELECT seats_allocated, 
                   (SELECT COUNT(*) FROM users WHERE organisation_id = ? AND email_verified = TRUE AND is_active = TRUE) as verified_active_count
            FROM organisations 
            WHERE id = ?
        ");
        $stmt->execute([$userOrg['organisation_id'], $userOrg['organisation_id']]);
        $org = $stmt->fetch();
        
        if ($org && $org['verified_active_count'] >= $org['seats_allocated']) {
            return ['success' => false, 'message' => 'No available seats for this organisation. Please contact your administrator.'];
        }
        
        // Verify email and activate account
        $stmt = $db->prepare("
            UPDATE users 
            SET email_verified = TRUE, 
                is_active = TRUE, 
                verification_token = NULL, 
                verification_token_expires_at = NULL 
            WHERE id = ?
        ");
        $stmt->execute([$user['id']]);
        
        // Update seats_used count (only verified and active users count)
        $stmt = $db->prepare("
            UPDATE organisations 
            SET seats_used = (
                SELECT COUNT(*) 
                FROM users 
                WHERE organisation_id = ? AND email_verified = TRUE AND is_active = TRUE
            )
            WHERE id = ?
        ");
        $stmt->execute([$userOrg['organisation_id'], $userOrg['organisation_id']]);
        
        return ['success' => true, 'message' => 'Email verified successfully! You can now log in.'];
    }
    
    /**
     * Resend verification email
     */
    public static function resendVerificationEmail($email) {
        $db = getDbConnection();
        
        $stmt = $db->prepare("
            SELECT id, first_name, email_verified 
            FROM users 
            WHERE email = ?
        ");
        $stmt->execute([$email]);
        $user = $stmt->fetch();
        
        if (!$user) {
            return ['success' => false, 'message' => 'Email not found.'];
        }
        
        if ($user['email_verified']) {
            return ['success' => false, 'message' => 'Email is already verified.'];
        }
        
        // Generate new verification token
        $verificationToken = Email::generateVerificationToken();
        $tokenExpires = date('Y-m-d H:i:s', strtotime('+' . VERIFICATION_TOKEN_EXPIRY_HOURS . ' hours'));
        
        $stmt = $db->prepare("
            UPDATE users 
            SET verification_token = ?, verification_token_expires_at = ? 
            WHERE id = ?
        ");
        $stmt->execute([$verificationToken, $tokenExpires, $user['id']]);
        
        // Send verification email
        $emailSent = Email::sendVerificationEmail($email, $user['first_name'], $verificationToken);
        
        if ($emailSent) {
            return ['success' => true, 'message' => 'Verification email sent. Please check your inbox.'];
        } else {
            return ['success' => false, 'message' => 'Failed to send verification email. Please try again later.'];
        }
    }
    
    /**
     * Validate password strength
     */
    public static function validatePasswordStrength($password) {
        $errors = [];
        
        if (strlen($password) < PASSWORD_MIN_LENGTH) {
            $errors[] = 'Password must be at least ' . PASSWORD_MIN_LENGTH . ' characters long.';
        }
        
        if (PASSWORD_REQUIRE_UPPERCASE && !preg_match('/[A-Z]/', $password)) {
            $errors[] = 'Password must contain at least one uppercase letter.';
        }
        
        if (PASSWORD_REQUIRE_LOWERCASE && !preg_match('/[a-z]/', $password)) {
            $errors[] = 'Password must contain at least one lowercase letter.';
        }
        
        if (PASSWORD_REQUIRE_NUMBER && !preg_match('/[0-9]/', $password)) {
            $errors[] = 'Password must contain at least one number.';
        }
        
        if (PASSWORD_REQUIRE_SPECIAL && !preg_match('/[^A-Za-z0-9]/', $password)) {
            $errors[] = 'Password must contain at least one special character.';
        }
        
        return $errors;
    }
    
    /**
     * Logout user
     */
    public static function logout() {
        // Ensure session is started
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
        
        // Preserve CSRF token
        $csrfToken = $_SESSION[CSRF_TOKEN_NAME] ?? null;
        
        // Clear all session data
        $_SESSION = [];
        
        // Destroy the session cookie
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', time() - 3600, '/');
        }
        
        // Destroy the session
        session_destroy();
        
        // Start a new clean session
        session_start();
        
        // Regenerate session ID to prevent session fixation
        session_regenerate_id(true);
        
        // Restore CSRF token in new session
        if ($csrfToken !== null) {
            $_SESSION[CSRF_TOKEN_NAME] = $csrfToken;
        }
    }
    
    /**
     * Hash password
     */
    public static function hashPassword($password) {
        return password_hash($password, PASSWORD_DEFAULT);
    }
    
    /**
     * Verify password
     */
    public static function verifyPassword($password, $hash) {
        return password_verify($password, $hash);
    }
    
    /**
     * Register new user with domain-based organisation association
     * Domain is automatically extracted from email address
     */
    public static function register($email, $password, $firstName, $lastName, $domain = null) {
        // #region agent log
        $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
        $logData = ['location' => 'Auth.php:400', 'message' => 'Auth::register called', 'data' => ['email' => substr($email, 0, 10) . '...', 'has_domain' => $domain !== null, 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'D'];
        @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
        // #endregion
        
        $db = getDbConnection();
        
        // Extract domain from email if not provided
        if ($domain === null) {
            $domain = substr(strrchr($email, '@'), 1);
            if (empty($domain)) {
                // #region agent log
                $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
                $logData = ['location' => 'Auth.php:408', 'message' => 'Invalid email format', 'data' => ['email' => substr($email, 0, 10) . '...', 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'F'];
                @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
                // #endregion
                return ['success' => false, 'message' => 'Invalid email address format.'];
            }
        }
        
        // #region agent log
        $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
        $logData = ['location' => 'Auth.php:414', 'message' => 'Looking up organisation', 'data' => ['domain' => $domain, 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'F'];
        @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
        // #endregion
        
        // Find organisation by domain
        $stmt = $db->prepare("SELECT id, seats_allocated, seats_used FROM organisations WHERE domain = ?");
        $stmt->execute([$domain]);
        $organisation = $stmt->fetch();
        
        if (!$organisation) {
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:418', 'message' => 'Organisation not found', 'data' => ['domain' => $domain, 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'F'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            return ['success' => false, 'message' => 'No organisation found for email domain "' . htmlspecialchars($domain) . '". Your organisation needs to be set up before you can register. Please <a href="' . url('request-access.php') . '">request access</a> for your organisation first.'];
        }
        
        // #region agent log
        $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
        $logData = ['location' => 'Auth.php:430', 'message' => 'Organisation found', 'data' => ['org_id' => $organisation['id'], 'seats_allocated' => $organisation['seats_allocated'], 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'G'];
        @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
        // #endregion
        
        // Check if seats are available (only count verified and active users)
        $stmt = $db->prepare("
            SELECT COUNT(*) as verified_active_count 
            FROM users 
            WHERE organisation_id = ? AND email_verified = TRUE AND is_active = TRUE
        ");
        $stmt->execute([$organisation['id']]);
        $verifiedActiveCount = $stmt->fetch()['verified_active_count'];
        
        // #region agent log
        $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
        $logData = ['location' => 'Auth.php:437', 'message' => 'Seats check', 'data' => ['verified_active_count' => $verifiedActiveCount, 'seats_allocated' => $organisation['seats_allocated'], 'has_available_seats' => $verifiedActiveCount < $organisation['seats_allocated'], 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'G'];
        @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
        // #endregion
        
        if ($verifiedActiveCount >= $organisation['seats_allocated']) {
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:440', 'message' => 'No seats available', 'data' => ['timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'G'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            return ['success' => false, 'message' => 'No available seats for this organisation.'];
        }
        
        // Check if email already exists
        $stmt = $db->prepare("SELECT id FROM users WHERE email = ?");
        $stmt->execute([$email]);
        if ($stmt->fetch()) {
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:447', 'message' => 'Email already exists', 'data' => ['timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'H'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            return ['success' => false, 'message' => 'Email already registered.'];
        }
        
        try {
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:451', 'message' => 'Starting transaction', 'data' => ['timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'I'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            
            $db->beginTransaction();
            
            // Generate verification token
            $verificationToken = Email::generateVerificationToken();
            $tokenExpires = date('Y-m-d H:i:s', strtotime('+' . VERIFICATION_TOKEN_EXPIRY_HOURS . ' hours'));
            
            // Create user (inactive until email verified)
            $passwordHash = self::hashPassword($password);
            $stmt = $db->prepare("
                INSERT INTO users (organisation_id, email, password_hash, first_name, last_name, email_verified, verification_token, verification_token_expires_at, is_active)
                VALUES (?, ?, ?, ?, ?, FALSE, ?, ?, FALSE)
            ");
            $stmt->execute([
                $organisation['id'],
                $email,
                $passwordHash,
                $firstName,
                $lastName,
                $verificationToken,
                $tokenExpires
            ]);
            
            $userId = $db->lastInsertId();
            
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:475', 'message' => 'User created', 'data' => ['user_id' => $userId, 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'I'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            
            // Assign default staff role
            $stmt = $db->prepare("SELECT id FROM roles WHERE name = 'staff'");
            $stmt->execute();
            $role = $stmt->fetch();
            
            if ($role) {
                $stmt = $db->prepare("INSERT INTO user_roles (user_id, role_id) VALUES (?, ?)");
                $stmt->execute([$userId, $role['id']]);
            }
            
            // Don't update seats_used here - seats are only counted when email is verified
            // Seats will be updated when verifyEmail() is called
            
            $db->commit();
            
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:491', 'message' => 'Transaction committed', 'data' => ['timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'I'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            
            // Send verification email
            $emailSent = Email::sendVerificationEmail($email, $firstName, $verificationToken);
            
            if (!$emailSent) {
                // Log error but don't fail registration - user can request resend
                error_log("Failed to send verification email to: $email");
            }
            
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:500', 'message' => 'Registration successful', 'data' => ['email_sent' => $emailSent, 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'I'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            
            return [
                'success' => true, 
                'message' => 'Registration successful! Please check your email to verify your account. The verification link will expire in ' . VERIFICATION_TOKEN_EXPIRY_HOURS . ' hours.'
            ];
        } catch (Exception $e) {
            // #region agent log
            $debugLogPath = (defined('ROOT_PATH') ? ROOT_PATH : dirname(__DIR__, 2)) . '/.cursor/debug.log';
            $logData = ['location' => 'Auth.php:507', 'message' => 'Exception caught', 'data' => ['error' => $e->getMessage(), 'trace' => substr($e->getTraceAsString(), 0, 300), 'timestamp' => date('Y-m-d H:i:s')], 'timestamp' => time() * 1000, 'sessionId' => 'debug-session', 'runId' => 'run1', 'hypothesisId' => 'E'];
            @file_put_contents($debugLogPath, json_encode($logData) . "\n", FILE_APPEND | LOCK_EX);
            // #endregion
            $db->rollBack();
            return ['success' => false, 'message' => 'Registration failed: ' . $e->getMessage()];
        }
    }
    
    /**
     * Require login - redirect if not logged in
     */
    public static function requireLogin() {
        // Ensure session is started
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
        
        // Check if user is logged in
        if (!self::isLoggedIn()) {
            // Preserve CSRF token when clearing session
            $csrfToken = $_SESSION[CSRF_TOKEN_NAME] ?? null;
            $_SESSION = [];
            if ($csrfToken !== null) {
                $_SESSION[CSRF_TOKEN_NAME] = $csrfToken;
            }
            
            // Use url() helper if available, otherwise fallback to relative path
            if (function_exists('url')) {
                $loginUrl = url('login.php');
            } else {
                $baseUrl = function_exists('getBaseUrl') ? getBaseUrl() : '';
                $loginUrl = ($baseUrl ?: '') . '/login.php';
            }
            
            // Ensure no output has been sent
            if (!headers_sent()) {
                header('Location: ' . $loginUrl);
            }
            exit;
        }
        
        // Double-check: verify user actually exists and is active
        $userId = self::getUserId();
        if ($userId) {
            $db = getDbConnection();
            $stmt = $db->prepare("SELECT id, is_active, email_verified FROM users WHERE id = ?");
            $stmt->execute([$userId]);
            $user = $stmt->fetch();
            
            if (!$user || !$user['is_active']) {
                // User doesn't exist or is inactive - force logout
                self::logout();
                if (function_exists('url')) {
                    $loginUrl = url('login.php');
                } else {
                    $baseUrl = function_exists('getBaseUrl') ? getBaseUrl() : '';
                    $loginUrl = ($baseUrl ?: '') . '/login.php';
                }
                if (!headers_sent()) {
                    header('Location: ' . $loginUrl);
                }
                exit;
            }
        }
    }
}

